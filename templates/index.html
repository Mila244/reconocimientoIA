<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Inventario con VisiÃ³n</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <h1>ğŸ“¦ Inventario</h1>

  <!-- === Reconocimiento por Imagen === -->
<!-- === Reconocimiento por Imagen === -->
<div class="card">
  <h3>ğŸ” Reconocer producto por imagen</h3>
  <div class="grid grid-2">
    <div>
      <!-- ğŸ“¸ CÃ¡mara -->
      <video id="camera" autoplay playsinline style="width:100%; max-width:320px; border-radius:10px; display:none;"></video>
      <canvas id="snapshot" style="display:none;"></canvas>

      <!-- ğŸ“¤ Cargar o tomar foto -->
      <div class="buttons">
        <button id="btnCamara" type="button">ğŸ“· Usar cÃ¡mara</button>
        <input type="file" id="fileInput" accept="image/*" capture="environment">
        <button id="btnReconocer" type="button">ğŸ” Reconocer</button>
      </div>

      <div><img id="preview" class="preview" alt=""></div>
      <span id="estado" class="muted"></span>
    </div>
    <div>
      <h4>Resultado</h4>
      <div id="resultado">Toma o sube una foto enfocando el producto.</div>
    </div>
  </div>
  <small class="muted">âœ¨ Sugerencia: usa buena iluminaciÃ³n y enfoca el producto.</small>
</div>



  <!-- === Alta de producto === -->
  <div class="card">
    <h3>â• Agregar producto</h3>
    <form action="{{ url_for('agregar') }}" method="post" enctype="multipart/form-data">
      <input type="text" name="nombre" placeholder="Nombre del producto" required>
      <input type="text" name="categoria" placeholder="CategorÃ­a">

      <!-- ğŸ”½ Nuevo campo: marca -->
      <select name="marca" required>
        <option value="">Seleccionar marca</option>
        <option value="Natura">Natura</option>
        <option value="Ã‰sika">Ã‰sika</option>
        <option value="Yanbal">Yanbal</option>
        <option value="Cyzone">Cyzone</option>
        <option value="L'Bel">Lâ€™Bel</option>
        <option value="Avon">Avon</option>
        <option value="Otro">Otro</option>
      </select>

      <input type="number" step="0.01" name="precio" placeholder="Precio" required>
      <input type="file" name="imagen" accept="image/*" required>
      <button type="submit">Agregar</button>
    </form>
    <div class="muted">ğŸ“Œ La imagen subida se usarÃ¡ como referencia para reconocimiento.</div>
  </div>

  <!-- === Listado === -->
  <h2>ğŸ“‹ Lista de productos</h2>
  <table>
    <tr>
      <th>Nombre</th>
      <th>CategorÃ­a</th>
      <th>Marca</th>
      <th>Precio</th>
      <th>Fecha ingreso</th>
      <th>Imagen</th>
      <th>Acciones</th>
    </tr>
    {% for p in productos %}
    <tr>
      <td>{{ p['nombre'] }}</td>
      <td>{{ p['categoria'] }}</td>
      <td>{{ p['marca'] }}</td>
      <td>S/. {{ p['precio'] }}</td>
      <td>{{ p['fecha_ingreso'] }}</td>
      <td>
        {% if p['imagen'] %}
          <img src="{{ p['imagen'] }}" width="100">
        {% endif %}
      </td>
      <td>
        <!-- BotÃ³n Modificar -->
        <form action="{{ url_for('editar', id=p['id']) }}" method="get" style="display:inline;">
          <button type="submit" style="background:#f1c40f; border:none; color:white; border-radius:8px; padding:6px 10px; cursor:pointer;">âœï¸ Modificar</button>
        </form>

        <!-- BotÃ³n Eliminar -->
        <form action="{{ url_for('eliminar', id=p['id']) }}" method="post" style="display:inline;" onsubmit="return confirm('Â¿Seguro que deseas eliminar este producto?');">
          <button type="submit" style="background:#e74c3c; border:none; color:white; border-radius:8px; padding:6px 10px; cursor:pointer;">ğŸ—‘ï¸ Eliminar</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>

  <!-- === Script cÃ¡mara y reconocimiento === -->
  <script>
const fileInput = document.getElementById('fileInput');
const preview   = document.getElementById('preview');
const btn       = document.getElementById('btnReconocer');
const out       = document.getElementById('resultado');
const estado    = document.getElementById('estado');
const video     = document.getElementById('camera');
const btnCamara = document.getElementById('btnCamara');
const canvas    = document.getElementById('snapshot');

// ğŸ¥ Activar cÃ¡mara
btnCamara.addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    video.style.display = 'block';
    preview.src = "";
    estado.textContent = "ğŸ“¸ CÃ¡mara activa. Puedes presionar 'Reconocer' para tomar la foto.";
  } catch (err) {
    alert("No se pudo acceder a la cÃ¡mara.");
    console.error(err);
  }
});

// ğŸ§  Reconocer producto (por cÃ¡mara o imagen subida)
btn.addEventListener('click', async () => {
  let blob;

  // Si cÃ¡mara estÃ¡ activa, tomar snapshot
  if (video.style.display === 'block') {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL('image/jpeg');
    preview.src = dataUrl;
    blob = await (await fetch(dataUrl)).blob();
  } 
  // Si hay imagen seleccionada manualmente
  else if (fileInput.files?.length) {
    blob = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => { preview.src = e.target.result; };
    reader.readAsDataURL(blob);
  } 
  else {
    alert("Selecciona o toma una imagen primero.");
    return;
  }

  const fd = new FormData();
  fd.append('imagen', blob);
  estado.textContent = "Procesando...";
  out.innerHTML = "";

  try {
    const r = await fetch('/reconocer', { method: 'POST', body: fd });
    const data = await r.json();
    estado.textContent = "";

    if (!data.ok) {
      out.innerHTML = `<span class="warn">${data.msg}</span>` +
                      (data.debug_score ? ` (score=${data.debug_score})` : "");
      return;
    }

    out.innerHTML = `
      <div class="ok"><b>Producto reconocido âœ”</b></div>
      <div><b>${data.nombre}</b> (${data.categoria})</div>
      <div>Marca: ${data.marca}</div>
      <div>Precio: S/. ${data.precio}</div>
      <div>Fecha ingreso: ${data.fecha_ingreso}</div>
      ${data.imagen ? `<div><img src="${data.imagen}" width="120"></div>` : ""}
    `;
  } catch (e) {
    estado.textContent = "";
    out.innerHTML = `<span class="warn">âš  Error llamando al backend</span>`;
    console.error(e);
  }
});
</script>


</body>
</html>
